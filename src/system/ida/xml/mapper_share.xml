<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mapper 태그 선언 -->
<mapper namespace="system.ida.dao.ShareDAO">
	<select id="getDifferentShareList" parameterType="system.ida.dto.ShareSearchDTO" resultType="system.ida.dto.ShareDTO">
		select
			sh.si_no "SI_NO",
			s.com_name "COM_NAME",
			(select addr.city from code_addr addr where addr.addr_code=(select st.addr_code from store st where st.s_id!=#{s_id} and st.s_no=(select ig.s_no from ingredient ig where ig.i_no=(select stk.i_no from stock stk where stk.st_no=(select sit.st_no from share_ingredient sit where sit.si_no=sh.si_no) )))) "CITY",
			(select addr.gun from code_addr addr where addr.addr_code=(select st.addr_code from store st where st.s_id!=#{s_id} and st.s_no=(select ig.s_no from ingredient ig where ig.i_no=(select stk.i_no from stock stk where stk.st_no=(select sit.st_no from share_ingredient sit where sit.si_no=sh.si_no) ))))  "GUN",
			(select addr.gu from code_addr addr where addr.addr_code=(select st.addr_code from store st where st.s_id!=#{s_id} and st.s_no=(select ig.s_no from ingredient ig where ig.i_no=(select stk.i_no from stock stk where stk.st_no=(select sit.st_no from share_ingredient sit where sit.si_no=sh.si_no) ))))  "GU",
			(select addr.dong from code_addr addr where addr.addr_code=(select st.addr_code from store st where st.s_id!=#{s_id} and st.s_no=(select ig.s_no from ingredient ig where ig.i_no=(select stk.i_no from stock stk where stk.st_no=(select sit.st_no from share_ingredient sit where sit.si_no=sh.si_no) ))))  "dong",
			(select addr.ri from code_addr addr where addr.addr_code=(select st.addr_code from store st where st.s_id!=#{s_id} and st.s_no=(select ig.s_no from ingredient ig where ig.i_no=(select stk.i_no from stock stk where stk.st_no=(select sit.st_no from share_ingredient sit where sit.si_no=sh.si_no) ))))  "RI",
            (select ia.ia_name from code_ingredient_alpha ia where ia.ia_code=i.ia_code)  "IA_NAME",
            (select ib.ib_name from code_ingredient_beta ib where ib.ib_code=i.ib_code)  "IB_NAME",
            (select io.io_name from code_ingredient_origin io where io.io_code=i.io_code)  "IO_NAME",
            i.i_name "I_NAME",
            sh.si_quantity "SI_QUANTITY",
            decode(sh.sr_state, 'i', '입고', 'o', '출고') "SR_STATE",
            to_char(sh.reg_date,'yyyy-mm-dd(dy) hh:mi') "REG_DATE"
        from share_ingredient sh, store s, ingredient i 
        where sh.st_no=(select st.st_no from stock st where st.i_no in i.i_no) and s.com_name=(select com_name from store where s_no=i.s_no) and s.s_id!=#{s_id}     
	</select>
	
	<select id="getMyShareList" parameterType="system.ida.dto.ShareSearchDTO" resultType="system.ida.dto.ShareDTO">
		select
			sh.si_no "SI_NO",
            (select ia.ia_name from code_ingredient_alpha ia where ia.ia_code=i.ia_code)  "IA_NAME",
            (select ib.ib_name from code_ingredient_beta ib where ib.ib_code=i.ib_code)  "IB_NAME",
            (select io.io_name from code_ingredient_origin io where io.io_code=i.io_code)  "IO_NAME",
            i.i_name "I_NAME",
            sh.si_quantity "SI_QUANTITY",
            decode(sh.sr_state, 'i', '입고', 'o', '출고') "SR_STATE",
            to_char(sh.reg_date,'yyyy-mm-dd(dy) hh:mi') "REG_DATE"
        from share_ingredient sh, store s, ingredient i 
        where sh.st_no=(select st.st_no from stock st where st.i_no in i.i_no) and s.com_name=(select com_name from store where s_no=i.s_no) and s.s_id=#{s_id}   
	</select>
	
	<select id="getStockList" parameterType="system.ida.dto.ShareSearchDTO" resultType="system.ida.dto.StockDTO">
		select
			s.st_no "ST_NO",
			i.i_name "I_NAME"
		from stock s, ingredient i
		where s.i_no=i.i_no and s.i_no in (select ig.i_no from ingredient ig where ig.s_no=(select sr.s_no from store sr where s_id=#{s_id}))
	</select>
	
	<insert id="insertShare" parameterType="system.ida.dto.ShareDTO">
		insert into share_ingredient(
			si_no
			,st_no
			,si_quantity
			,sr_state
			,deal
		) values (
			(select nvl(max(si_no),0)+1 from share_ingredient)
			,${st_no}
			,${si_quantity}
			,#{sr_state}
			,#{deal}
		)
	</insert>
	
	<insert id="insertStockRecord" parameterType="system.ida.dto.ShareDTO">
		insert into share_ingredient_record(
			si_no
			,s_no
		) values (
			(select nvl(max(si_no),0)+1 from share_ingredient_record)
			,(select s_no from store where s_id=#{s_id})
		)	
	</insert>
	
	<select id="getInsertedShareCnt" parameterType="system.ida.dto.ShareDTO" resultType="int">
		select 
			count(*) 
		from share_ingredient si
		where si.st_no=${st_no} and si.sr_state=#{sr_state}
	</select>
</mapper>